@model EPiServer.Reference.Commerce.Site.Features.Checkout.ViewModels.CheckoutViewModel
@using EPiServer.Reference.Commerce.Site.Features.AddressBook.Helpers
@using LL.EpiserverCyberSourceConnector
@using LL.EpiserverCyberSourceConnector.Payments.CreditCard

@* Secure Acceptance form. This form will be submitted from front-end. In this way the Credit Card data will not hit the back-end. *@
<form action="https://testsecureacceptance.CyberSource.com/silent/pay" method="post" id="secure-acceptance-form"></form>

<script>
        @{
            var signedFields = SecureAcceptanceHelper.GetSignedFieldsValue();
            var cardTypeDictionary = CreditCardTypeStore.CardTypes;
            var countryCodes = AddressHelper.CountryCodes;
            var states = AddressHelper.StatesWithCode;
        }

        var cardTypes = @Html.Raw(Json.Encode(cardTypeDictionary));
        var countryCodes = @Html.Raw(Json.Encode(countryCodes));
        var states = @Html.Raw(Json.Encode(states));

        var processCreditCardSubmit = function(event) {
            event.preventDefault();

            var action = window.addPaymentOnCartEndpoint;
            var formData = new FormData(form);
            var xhr = new XMLHttpRequest();

            xhr.open('POST', action, true);
            xhr.send(formData);

            xhr.onreadystatechange = function () {
                if (this.readyState === XMLHttpRequest.DONE) {
                    if (this.status === 200) {
                        signFields();
                    } else {
                        console.log("sign fields error", this.response);
                    }
                }
            }
        }

        function signFields() {
            var accessKey = "@Model.CreditCardConfiguration.AccessKey";
            var profileId = "@Model.CreditCardConfiguration.ProfileId";
            var transactionType = "@Model.CreditCardConfiguration.SecureAcceptanceTransactionType";
            var unsignedFieldNames = "@Model.CreditCardConfiguration.UnsignedFields";
            var signedFieldNames = "@signedFields";
            var currency = document.getElementById("CurrencyCode").value;
            var languageField = document.getElementById("Language");
            var locale = languageField.options[languageField.selectedIndex].value;
            var amountValue = document.querySelector("#total-price .product-price__currency-marker").nextSibling.textContent;

            // TODO: change for logged in users
            var firstName =document.getElementById("BillingAddress_FirstName").value;
            var lastName = document.getElementById("BillingAddress_LastName").value;
            var email = document.getElementById("BillingAddress_Email").value;
            var addressLine1 = document.getElementById("BillingAddress_Line1").value;
            var city = document.getElementById("BillingAddress_City").value;
            var postalCode = document.getElementById("BillingAddress_PostalCode").value;

            var stateField = document.getElementById("BillingAddress_CountryRegion_Region");
            var stateValue = stateField.options[stateField.selectedIndex].text;
            var state = states[stateValue];

            var countryField = document.getElementById("BillingAddress_CountryCode");
            var countryValue = countryField.options[countryField.selectedIndex].value;
            var country = countryCodes[countryValue];

            var cardNumber = document.getElementById("credit-card-number").value;
            var cardTypeName = getCardType(cardNumber);
            var cardType = cardTypes[cardTypeName];
            var cardExpireMonth = document.getElementById("credit-card-expiration-month").value;
            var cardExpireYear = document.getElementById("credit-card-expiration-year").value;

            var data = {
                accessKey: accessKey,
                profileId: profileId,
                transactionType: transactionType,
                unsignedFieldNames: unsignedFieldNames,
                signedFieldNames: signedFieldNames,
                transactionUuid: "@Guid.NewGuid().ToString()",
                transactionDateTime: "@DateTime.Now.ToUniversalTime().ToString("yyyy-MM-dd'T'HH:mm:ss'Z'")",
                currency: currency,
                locale: locale,
                amount: amountValue,
                firstName: firstName,
                lastName: lastName,
                email: email,
                addressLine1: addressLine1,
                city: city,
                state: state,
                country: country,
                postalCode: postalCode,
                cardType: cardType,
                cardNumber: cardNumber.replace(/\s/g, ''),
                cardExpireYear: cardExpireYear,
                cardExpireMonth: cardExpireMonth,
                signFieldsUrl: "/SecureAcceptance/SignFields",
                secureAcceptanceFormId: "secure-acceptance-form"
            };
            sign(data);
        }
</script>

<script src="~/Scripts/secure-acceptance-sample.js" type="text/javascript"></script>